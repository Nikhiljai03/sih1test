{% extends "base.html" %}
{% block head %}
<!-- load ethers first -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
{% endblock %}
{% block content %}

<div class="max-w-2xl mx-auto animate__animated animate__fadeInUp animate__faster">
  <!-- Language Selector -->
  <div class="flex justify-end mb-2">
    <label for="langSelect" class="mr-2 font-semibold">üåê</label>
    <select id="langSelect" class="border rounded px-2 py-1">
      <option value="en">English</option>
      <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
      <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
    </select>
  </div>
  <div class="bg-white bg-opacity-80 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200 transition-all duration-300 hover:shadow-2xl">
    <div class="flex items-center gap-2 mb-4">
      <svg class="w-7 h-7 text-green-600 animate__animated animate__pulse animate__infinite" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2C7.03 2 2.5 6.03 2.5 11c0 4.97 4.53 9 9.5 9s9.5-4.03 9.5-9c0-4.97-4.53-9-9.5-9z"/></svg>
  <h2 id="titleDash" class="text-2xl font-bold text-green-700 tracking-tight">Farmer Dashboard</h2>
    </div>
    <div class="mb-4 flex items-center gap-2">
  <span id="labelWallet" class="font-mono text-sm text-gray-700">Wallet:</span>
      <span id="walletAddr" class="font-mono text-xs px-2 py-1 rounded bg-gray-100 border border-gray-300">{{ user.wallet_address or 'Not linked' }}</span>
  <button id="btnLink" class="ml-2 px-3 py-1 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-all duration-200 animate__animated animate__fadeIn">Connect & Link Wallet</button>
    </div>
    <form class="space-y-4">
      <div class="mb-2">
        <label id="labelSelectCrop" class="block text-sm font-medium text-gray-700 mb-1">Select Crop</label>
        <button id="btnSelectCrop" type="button" onclick="toggleCropGrid()" class="px-3 py-1 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition mb-2">Select Crop</button>
        <div id="cropGrid" class="grid grid-cols-4 gap-3 mb-2" style="display:none;">
          <img src="/static/crops/potato.png" alt="Potato" class="cursor-pointer rounded-lg border-2 border-transparent hover:border-green-400" onclick="selectCrop('Potato')">
          <img src="/static/crops/tomato.png" alt="Tomato" class="cursor-pointer rounded-lg border-2 border-transparent hover:border-green-400" onclick="selectCrop('Tomato')">
          <img src="/static/crops/apple.png" alt="Apple" class="cursor-pointer rounded-lg border-2 border-transparent hover:border-green-400" onclick="selectCrop('Apple')">
          <img src="/static/crops/carrot.png" alt="Carrot" class="cursor-pointer rounded-lg border-2 border-transparent hover:border-green-400" onclick="selectCrop('Carrot')">
          <!-- Add more crops as needed -->
        </div>
      </div>
      <div>
  <label id="labelCropName" for="name" class="block text-sm font-medium text-gray-700">Crop Name</label>
  <input id="name" class="input input-bordered w-full" placeholder="Crop name" />
      </div>
      <div>
  <label id="labelDesc" for="desc" class="block text-sm font-medium text-gray-700">Description</label>
  <textarea id="desc" class="textarea textarea-bordered w-full" placeholder="Description"></textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label id="labelQty" for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
          <input id="quantity" type="number" class="input input-bordered w-full" placeholder="Quantity" />
        </div>
        <div>
          <label id="labelQuality" for="quality" class="block text-sm font-medium text-gray-700">Quality</label>
          <select id="quality" class="input input-bordered w-full">
            <option value="premium">Premium</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label id="labelFert" for="fertilizer" class="block text-sm font-medium text-gray-700">Type of Fertilizers Used</label>
          <select id="fertilizer" class="input input-bordered w-full">
            <option value="urea">Urea</option>
            <option value="compost">Compost</option>
            <option value="vermicompost">Vermicompost</option>
            <option value="biofertilizer">Biofertilizer</option>
            <option value="npk">NPK</option>
            <option value="dap">DAP</option>
          </select>
        </div>
        <div>
          <label id="labelOrg" for="organic" class="block text-sm font-medium text-gray-700">Organic/Inorganic</label>
          <select id="organic" class="input input-bordered w-full">
            <option value="organic">Organic</option>
            <option value="inorganic">Inorganic</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label id="labelSoil" for="soil" class="block text-sm font-medium text-gray-700">Soil Type</label>
          <select id="soil" class="input input-bordered w-full">
            <option value="loamy">Loamy</option>
            <option value="sandy">Sandy</option>
            <option value="sandy loam">Sandy Loam</option>
            <option value="clay">Clay</option>
            <option value="silt">Silt</option>
          </select>
        </div>
        <div>
          <label id="labelIrr" for="irrigation" class="block text-sm font-medium text-gray-700">Irrigation Method</label>
          <select id="irrigation" class="input input-bordered w-full">
            <option value="drip">Drip</option>
            <option value="sprinkler">Sprinkler</option>
            <option value="flood">Flood</option>
            <option value="manual">Manual</option>
          </select>
        </div>
      </div>
  <button id="btnAdd" disabled class="btn btn-success w-full mt-4 animate__animated animate__pulse animate__infinite">Add Crop on-chain</button>
      <p id="status" class="text-green-600 mt-2"></p>
    </form>
  </div>
  <div class="bg-white bg-opacity-80 backdrop-blur-lg rounded-2xl shadow-xl p-8 border border-gray-200 transition-all duration-300 hover:shadow-2xl">
  <h3 id="labelProducts" class="text-xl font-semibold text-blue-700 mb-4 flex items-center gap-2"><svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v4a1 1 0 001 1h3m10-5v4a1 1 0 01-1 1h-3m-4 0h4"/></svg>Your recorded products (DB)</h3>
    <ul class="divide-y divide-gray-200">
      {% for p in user.products %}
        <li class="py-2 flex justify-between items-center animate__animated animate__fadeIn animate__faster">
          <span class="font-semibold text-gray-700">{{ p.name }}</span>
          <span class="text-xs text-gray-500">Qty: {{ p.quantity }}</span>
          <span class="text-xs text-gray-500">tx: {{ p.tx_hash or 'N/A' }}</span>
        </li>
      {% else %}
        <li class="py-2 text-gray-400">No products yet</li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
// Multi-lingual support
const translations = {
  en: {
    titleDash: "Farmer Dashboard",
    labelWallet: "Wallet:",
    btnLink: "Connect & Link Wallet",
    labelSelectCrop: "Select Crop",
    btnSelectCrop: "Select Crop",
    labelCropName: "Crop Name",
    labelDesc: "Description",
    labelQty: "Quantity",
    labelQuality: "Quality",
    labelFert: "Type of Fertilizers Used",
    labelOrg: "Organic/Inorganic",
    labelSoil: "Soil Type",
    labelIrr: "Irrigation Method",
    btnAdd: "Add Crop on-chain",
    labelProducts: "Your recorded products (DB)"
  },
  hi: {
    titleDash: "‡§ï‡§ø‡§∏‡§æ‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
    labelWallet: "‡§µ‡•â‡§≤‡•á‡§ü:",
    btnLink: "‡§µ‡•â‡§≤‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç",
    labelSelectCrop: "‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç",
    btnSelectCrop: "‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç",
    labelCropName: "‡§´‡§∏‡§≤ ‡§ï‡§æ ‡§®‡§æ‡§Æ",
    labelDesc: "‡§µ‡§ø‡§µ‡§∞‡§£",
    labelQty: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ",
    labelQuality: "‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ",
    labelFert: "‡§â‡§∞‡•ç‡§µ‡§∞‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
    labelOrg: "‡§ú‡•à‡§µ‡§ø‡§ï/‡§Ö‡§ú‡•à‡§µ‡§ø‡§ï",
    labelSoil: "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
    labelIrr: "‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§µ‡§ø‡§ß‡§ø",
    btnAdd: "‡§´‡§∏‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
    labelProducts: "‡§Ü‡§™‡§ï‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§´‡§∏‡§≤‡•á‡§Ç (DB)"
  },
  te: {
    titleDash: "‡∞∞‡±à‡∞§‡±Å ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç",
    labelWallet: "‡∞µ‡∞æ‡∞≤‡±Ü‡∞ü‡±ç:",
    btnLink: "‡∞µ‡∞æ‡∞≤‡±Ü‡∞ü‡±ç ‡∞ï‡∞®‡±Ü‡∞ï‡±ç‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
    labelSelectCrop: "‡∞™‡∞Ç‡∞ü‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø",
    btnSelectCrop: "‡∞™‡∞Ç‡∞ü‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø",
    labelCropName: "‡∞™‡∞Ç‡∞ü ‡∞™‡±á‡∞∞‡±Å",
    labelDesc: "‡∞µ‡∞ø‡∞µ‡∞∞‡∞£",
    labelQty: "‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç",
    labelQuality: "‡∞®‡∞æ‡∞£‡±ç‡∞Ø‡∞§",
    labelFert: "‡∞é‡∞∞‡±Å‡∞µ‡±Å‡∞≤ ‡∞∞‡∞ï‡∞Ç",
    labelOrg: "‡∞∏‡±á‡∞Ç‡∞¶‡±ç‡∞∞‡±Ä‡∞Ø/‡∞Ö‡∞∏‡±á‡∞Ç‡∞¶‡±ç‡∞∞‡±Ä‡∞Ø",
    labelSoil: "‡∞®‡±á‡∞≤ ‡∞∞‡∞ï‡∞Ç",
    labelIrr: "‡∞™‡±ä‡∞°‡∞ø‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞µ‡∞ø‡∞ß‡∞æ‡∞®‡∞Ç",
    btnAdd: "‡∞™‡∞Ç‡∞ü‡∞®‡±Å ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",
    labelProducts: "‡∞Æ‡±Ä ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∏‡∞ø‡∞® ‡∞™‡∞Ç‡∞ü‡∞≤‡±Å (DB)"
  }
};

function setLang(lang) {
  const t = translations[lang];
  document.getElementById('titleDash').innerText = t.titleDash;
  document.getElementById('labelWallet').innerText = t.labelWallet;
  document.getElementById('btnLink').innerText = t.btnLink;
  document.getElementById('labelSelectCrop').innerText = t.labelSelectCrop;
  document.getElementById('btnSelectCrop').innerText = t.btnSelectCrop;
  document.getElementById('labelCropName').innerText = t.labelCropName;
  document.getElementById('name').placeholder = t.labelCropName;
  document.getElementById('labelDesc').innerText = t.labelDesc;
  document.getElementById('desc').placeholder = t.labelDesc;
  document.getElementById('labelQty').innerText = t.labelQty;
  document.getElementById('quantity').placeholder = t.labelQty;
  document.getElementById('labelQuality').innerText = t.labelQuality;
  document.getElementById('labelFert').innerText = t.labelFert;
  document.getElementById('labelOrg').innerText = t.labelOrg;
  document.getElementById('labelSoil').innerText = t.labelSoil;
  document.getElementById('labelIrr').innerText = t.labelIrr;
  document.getElementById('btnAdd').innerText = t.btnAdd;
  document.getElementById('labelProducts').innerText = t.labelProducts;
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('langSelect').addEventListener('change', function(e) {
    setLang(e.target.value);
  });
});
function toggleCropGrid() {
  const grid = document.getElementById('cropGrid');
  grid.style.display = (grid.style.display === 'none') ? 'grid' : 'none';
}
function selectCrop(name) {
  document.getElementById('name').value = name;
  document.getElementById('cropGrid').style.display = 'none';
}
const CONTRACT_ADDRESS = "{{ contract_address }}";
const CONTRACT_ABI = JSON.parse(`{{ abi | safe }}`);

let provider, signer, contract;
const btnLink = document.getElementById('btnLink');
const btnAdd = document.getElementById('btnAdd');
const walletSpan = document.getElementById('walletAddr');
const status = document.getElementById('status');

async function connectAndLink() {
  status.innerText = '';
  if (!window.ethereum) {
    status.innerText = 'MetaMask not detected. Please install MetaMask.';
    alert('Install MetaMask');
    return;
  }
  try {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    const addr = await signer.getAddress();
    const message = `Link wallet to user {{ user.id }} at ${Date.now()}`;
    const signature = await signer.signMessage(message);
    const res = await fetch('/link_wallet', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message, signature, address: addr })
    });
    const j = await res.json();
    if (res.ok) {
      walletSpan.innerText = j.wallet_address;
      status.innerText = 'Wallet linked successfully';
      try {
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        btnAdd.disabled = false;
        status.innerText += '\nContract ready.';
      } catch (err) {
        status.innerText += '\nContract instantiation failed: ' + err.message;
        btnAdd.disabled = true;
      }
    } else {
      status.innerText = 'Failed to link wallet: ' + (j.error || JSON.stringify(j));
      btnAdd.disabled = true;
    }
  } catch (err) {
    status.innerText = 'Wallet linking error: ' + err.message;
    btnAdd.disabled = true;
  }
}

async function addCropOnChain() {
  status.innerText = '';
  if (!signer) {
    status.innerText = 'Wallet not connected.';
    alert('Connect wallet first');
    return;
  }
  if (!contract) {
    status.innerText = 'Contract not ready.';
    alert('Contract not ready. Please link wallet again.');
    return;
  }
  const name = document.getElementById('name').value.trim();
  const details = document.getElementById('desc').value.trim();
  const quantity = parseInt(document.getElementById('quantity').value || '0');
  const quality = document.getElementById('quality').value.trim();
  const fertilizer = document.getElementById('fertilizer').value.trim();
  const organic = document.getElementById('organic').value;
  const soil = document.getElementById('soil').value.trim();
  const irrigation = document.getElementById('irrigation').value.trim();
  const price = 0;
  if (!name || quantity < 0 || !fertilizer || !organic || !soil || !irrigation) {
    status.innerText = 'Enter all values.';
    alert('Enter all values');
    return;
  }
  try {
    status.innerText = 'Sending transaction... (confirm in MetaMask)';
    const tx = await contract.addCrop(
      name, details, price, quantity, quality, fertilizer, organic, soil, irrigation
    );
    status.innerText = 'Transaction sent. Waiting for confirmation...';
    const receipt = await tx.wait();
    status.innerText = 'Transaction mined: ' + receipt.transactionHash;
    // Record the product in our DB (server-side) with txHash
    const rec = await fetch('/record_product', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        name,
        description: details,
        quantity,
        quality,
        fertilizer,
        organic,
        soil,
        irrigation,
        price,
        txHash: receipt.transactionHash
      })
    });
    let jj;
    try {
      jj = await rec.json();
    } catch (err) {
      status.innerText += ' ‚Äî failed to parse DB response: ' + err.message;
      return;
    }
    if (rec.ok && jj.ok) {
      status.innerText += ' ‚Äî saved to DB';
      setTimeout(()=>location.reload(), 900);
    } else {
      status.innerText += ' ‚Äî failed to save DB: ' + (jj.error || JSON.stringify(jj));
      alert('Failed to save product in DB: ' + (jj.error || JSON.stringify(jj)));
    }
  } catch (e) {
    status.innerText = 'Transaction failed or rejected: ' + (e.message || e);
    alert('Transaction failed or rejected: ' + (e.message || e));
    console.error(e);
  }
}

btnLink.addEventListener('click', connectAndLink);
btnAdd.addEventListener('click', function(e) {
  e.preventDefault();
  addCropOnChain();
});
</script>
{% endblock %}
